# 全景图片批量处理程序

这是一个多线程批量处理全景图片的程序，可以将全景图片转换为多个透视图。

## 功能特点

- 支持批量处理文件夹中的全景图片
- 使用多线程加速处理
- 可配置视场角、重叠比例、输出尺寸等参数
- 支持多种图片格式（jpg, png, bmp, tiff等）
- **新增：角度排除功能** - 可排除指定角度范围的图片，减少拍摄人的影响
- **新增：垂直翻转功能** - 可处理倒置拍摄的全景图，自动翻转后进行处理

## 使用方法

### 1. 基本用法

```bash
python batch_process.py 输入文件夹 输出文件夹
```

### 2. 高级用法

```bash
python batch_process.py 输入文件夹 输出文件夹 --fov 90 --overlap 0.2 --size 1024 1024 --threads 8
```

### 3. 角度排除功能

```bash
# 排除150-210度范围的图片（拍摄人后方区域）
python batch_process.py 输入文件夹 输出文件夹 --exclude-angles 150 210 --enable-exclusion

# 排除多个角度范围
python batch_process.py 输入文件夹 输出文件夹 --exclude-angles 150 210 --exclude-angles 270 330 --enable-exclusion
```

### 4. 垂直翻转功能

```bash
# 启用垂直翻转，处理倒置拍摄的全景图
python batch_process.py 输入文件夹 输出文件夹 --flip-vertical

# 组合使用：翻转 + 角度排除 + 俯仰角度
python batch_process.py 输入文件夹 输出文件夹 --flip-vertical --pitch-angle 15 --exclude-angles 150 210 --enable-exclusion
```

### 5. 参数说明

- `输入文件夹`: 包含全景图片的文件夹路径
- `输出文件夹`: 处理结果的输出文件夹路径
- `--fov`: 视场角（度），默认90
- `--overlap`: 重叠比例（0-1），默认0.2
- `--size`: 输出图片尺寸，默认1024x1024
- `--threads`: 线程数，默认4
- `--pitch-angle`: 俯仰角度（度），正值向上，负值向下，默认0（水平）
- `--exclude-angles`: 排除的角度范围，格式为 START END，可多次使用
- `--enable-exclusion`: 启用角度排除功能
- `--flip-vertical`: 启用垂直翻转功能（用于处理倒置拍摄的全景图）

### 6. 使用示例

```bash
# 处理当前目录下的图片，使用默认参数
python batch_process.py

# 处理指定文件夹，使用8个线程
python batch_process.py ./panorama_images ./output --threads 8

# 自定义视场角和重叠比例
python batch_process.py ./input ./output --fov 60 --overlap 0.3 --threads 6

# 启用角度排除，排除拍摄人后方区域
python batch_process.py ./input ./output --exclude-angles 150 210 --enable-exclusion

# 启用垂直翻转，处理倒置拍摄的全景图
python batch_process.py ./input ./output --flip-vertical

# 组合使用：翻转 + 俯仰角度 + 角度排除
python batch_process.py ./input ./output --flip-vertical --pitch-angle -10 --exclude-angles 150 210 --enable-exclusion
```

## 垂直翻转功能详解

### 功能说明
垂直翻转功能专门用于处理倒置拍摄的全景图。当全景相机倒置拍摄时，生成的图片上下颠倒，直接处理会导致视角错误。

### 使用场景
1. **倒置拍摄**: 相机倒置安装拍摄的全景图
2. **特殊角度拍摄**: 需要从特定角度拍摄的全景图
3. **设备限制**: 由于设备安装限制必须倒置拍摄的情况

### 工作原理
启用垂直翻转功能后，程序会：
1. 在生成透视图之前，先将输入的全景图进行垂直翻转
2. 翻转后的图片按照正常的坐标系统进行处理
3. 生成的透视图具有正确的视角方向

### 注意事项
- 翻转功能会增加少量处理时间
- 建议在处理前确认图片确实需要翻转
- 可以与其他功能（角度排除、俯仰角度等）组合使用

## 角度排除功能详解

### 角度说明
- **0度**: 前方（图片正前方）
- **90度**: 右方（图片右侧）
- **180度**: 后方（图片后方，通常是拍摄人站立的位置）
- **270度**: 左方（图片左侧）

### 推荐设置
- **拍摄人后方**: 150-210度（排除拍摄人及其周围区域）
- **拍摄人左侧**: 270-330度（如果需要排除左侧区域）
- **拍摄人右侧**: 30-90度（如果需要排除右侧区域）

### 使用场景
1. **旅游摄影**: 排除拍摄人及其装备
2. **房地产展示**: 排除拍摄设备和人员
3. **景观摄影**: 排除不必要的干扰元素
4. **VR内容制作**: 提高沉浸式体验质量

## 输出结构

程序会为每张输入图片创建一个独立的输出文件夹：

```
输出文件夹/
├── 图片1名称/
│   ├── 图片1名称_view_000.jpg
│   ├── 图片1名称_view_001.jpg
│   └── ...
├── 图片2名称/
│   ├── 图片2名称_view_000.jpg
│   ├── 图片2名称_view_001.jpg
│   └── ...
└── ...
```

**注意**: 启用角度排除功能后，某些视角的图片会被跳过，因此输出图片的编号可能不连续。

## 性能优化建议

1. **线程数设置**: 根据CPU核心数设置合适的线程数
   - 4核CPU: 建议使用4-6个线程
   - 8核CPU: 建议使用6-8个线程
   - 16核CPU: 建议使用8-12个线程

2. **输出尺寸**: 较小的输出尺寸可以显著提高处理速度

3. **重叠比例**: 较小的重叠比例可以减少生成的图片数量

4. **角度排除**: 启用角度排除功能可以减少生成的图片数量，提高处理速度

## 系统要求

- Python 3.6+
- OpenCV (cv2)
- NumPy
- 支持的操作系统: Windows, macOS, Linux

## 安装依赖

```bash
pip install opencv-python numpy 
```

或

```
pip install -r requirements.txt
```

## 快速启动

使用交互式界面快速配置参数：

```bash
python quick_start.py
```

## 注意事项

1. 输入图片应该是全景图片（equirectangular格式）
2. 程序会自动创建输出文件夹
3. 处理大量图片时，确保有足够的磁盘空间
4. 建议先用少量图片测试参数设置
5. 角度排除功能会减少生成的图片数量，但提高整体质量
6. 角度范围必须在0-360度之间，起始角度必须小于结束角度
